<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>粗利計算ツール - GitHub Version</title>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 10px; background-color: #f4f4f9; color: #333; }
        .container { width: 100%; max-width: 1000px; margin: auto; background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        h2 { text-align: center; font-size: 1.4em; color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        
        .header-row { background-color: #007bff; color: white; padding: 10px; margin: 15px 0 10px 0; border-radius: 5px; font-weight: bold; text-align: center; }
        
        .input-group, .output-group { display: flex; flex-wrap: wrap; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background-color: #fafafa; }
        .output-group { background-color: #e9f7ef; border-color: #28a745; }
        
        .field { flex: 1 1 calc(50% - 20px); padding: 8px; box-sizing: border-box; }
        @media (min-width: 768px) { .field { flex: 1 1 calc(25% - 20px); } }
        
        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.85em; color: #666; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.9em; transition: border 0.2s; }
        input:focus { border-color: #007bff; outline: none; }

        /* 自动填充字段专用样式 */
        .readonly-field { background-color: #e0f7fa !important; border: 1px dashed #00bcd4 !important; font-weight: bold; color: #007c91; }
        
        #calculate_button { display: block; width: 100%; max-width: 300px; margin: 25px auto; padding: 15px; font-size: 1.1em; color: #fff; background-color: #28a745; border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #calculate_button:hover { background-color: #218838; transform: translateY(-1px); }
        
        .result-val { font-size: 1.1em; font-weight: bold; padding: 5px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <h2>线材粗利计算工具</h2>

    <div class="header-row">1. 号机选择与规格</div>
    <div class="input-group">
        <div class="field">
            <label>号机 (A12)</label>
            <select id="A12" onchange="lookupMachineData(); updateConfigSelector();">
                <script>
                    for(let i = 1; i <= 65; i++) {
                        document.write(`<option value="${i}" ${i === 11 ? 'selected' : ''}>MA-${i}</option>`);
                    }
                </script>
            </select>
        </div>
        <div id="config_selector_group" class="field" style="display:none; flex: 1 1 100%; background: #fffbe6; border-radius: 5px;">
            <label>配置选项 (MA-7/8/9 专用)</label>
            <select id="config_selector" onchange="lookupMachineData(true);"></select>
        </div>
        <div class="field">
            <label>头数 (D14)</label>
            <input type="number" id="D14" class="readonly-field" readonly>
        </div>
        <div class="field">
            <label>号机功率 (kW)</label>
            <input type="number" id="M14_power" class="readonly-field" readonly>
        </div>
        <div class="field">
            <label>线速 (m/min)</label>
            <input type="number" id="E14" value="410">
        </div>
    </div>

    <div class="header-row">2. 漆料型号与单价</div>
    <div class="input-group">
        <div class="field" style="flex: 1 1 50%;">
            <label>漆种类选择 (自动填入价格)</label>
            <select id="I7_select" onchange="updatePaintPrice()">
                <option value="">-- 请选择漆型号 --</option>
                <optgroup label="TPU系列">
                    <option value="28.88">TPU 6222 LKCF</option>
                    <option value="20.88">TPU 6228LKCF0.5</option>
                    <option value="50.48">TPU K5-132-30F</option>
                    <option value="21.77">TPU 230SA-3C-N</option>
                    <option value="21.77">TPU 3026K LK2.0</option>
                </optgroup>
                <optgroup label="APU系列">
                    <option value="37.82">APU-2826NSL</option>
                    <option value="29.31">APU-2826F</option>
                    <option value="32.26">APU-2835F</option>
                </optgroup>
                <optgroup label="1746系列">
                    <option value="14.16">1746/30 LS</option>
                    <option value="13.72">1746/30</option>
                    <option value="14.16">1746/30LK2.0</option>
                </optgroup>
                <optgroup label="Voltatex系列">
                    <option value="16.33">Voltatex 6325(T)</option>
                    <option value="16.28">Voltatex 6318LK0.1</option>
                    <option value="23.89">volatatex 7222</option>
                </optgroup>
                <optgroup label="1380系列">
                    <option value="17.26">1380/30E (T)</option>
                    <option value="16.37">1380/26E (T)</option>
                    <option value="17.96">1380/30E GSP</option>
                    <option value="16.81">1380/22E</option>
                    <option value="18.58">1380/30EL FJ 2.0</option>
                </optgroup>
                <option value="0">其他 (手动输入价格)</option>
            </select>
        </div>
        <div class="field">
            <label>漆单价 (I8) 元/kg</label>
            <input type="number" id="I8" class="readonly-field" value="13.72" step="0.01">
        </div>
        <div class="field">
            <label>当前品种名称 (A14)</label>
            <input type="text" id="A14" value="UEW">
        </div>
    </div>

    <div class="header-row">3. 生产与成本参数</div>
    <div class="input-group">
        <div class="field"><label>导体径 (mm)</label><input type="number" id="B14" value="0.09" step="0.001"></div>
        <div class="field"><label>仕上外径 (mm)</label><input type="number" id="C14" value="0.102" step="0.001"></div>
        <div class="field"><label>浓度 (%)</label><input type="number" id="I12" value="28"></div>
        <div class="field"><label>生产天数</label><input type="number" id="F12" value="30"></div>
        <div class="field"><label>加工费 (元/kg)</label><input type="number" id="H12" value="17.00"></div>
        <div class="field"><label>电费单价 (元/度)</label><input type="number" id="S14" value="0.574"></div>
        <div class="field">
            <label>线轴 (K6)</label>
            <select id="K6">
                <option value="PT10" selected>PT10</option><option value="PT15">PT15</option>
                <option value="PL8">PL8</option><option value="PL4">PL4</option>
                <option value="HKV125">HKV125</option>
            </select>
        </div>
        <div class="field">
            <label>目的地 (M11)</label>
            <select id="M11">
                <option value="華北" selected>華北</option><option value="華東">華東</option>
                <option value="華南">華南</option><option value="船">船</option>
            </select>
        </div>
    </div>

    <button id="calculate_button" onclick="calculateMargin()">开始核算成本</button>

    <div class="header-row" style="background-color: #28a745;">4. 计算结果</div>
    <div class="output-group">
        <div class="field"><label>总生产量 (kg)</label><div id="F14" class="result-val">0.00</div></div>
        <div class="field"><label>总成本 (元)</label><div id="O14" class="result-val">0.00</div></div>
        <div class="field" style="flex: 1 1 50%;"><label style="color:#007bff">粗利 (P14) / 元</label><div id="P14" class="result-val" style="color:#007bff; font-size: 1.4em;">0.00</div></div>
        <div class="field" style="flex: 1 1 50%;"><label style="color:#d9534f">含电费粗利 (Q14) / 元</label><div id="Q14" class="result-val" style="color:#d9534f; font-size: 1.4em;">0.00</div></div>
    </div>
</div>

<script>
    // --- 数据配置 ---
    const machineConfig = [
        [16, 111], [20, 166], [20, 166], [16, 94], [20, 49], [12, 104], [16, 99], [16, 101], [16, 99], [20, 64], 
        [20, 64], [16, 199], [32, 101], [32, 101], [20, 64], [20, 68], [20, 68], [20, 68], [20, 63], [20, 63], 
        [16, 100], [12, 90], [12, 75], [20, 61], [12, 99], [12, 93], [12, 93], [12, 99], [12, 93], [12, 99], 
        [12, 99], [12, 99], [20, 68], [16, 61], [12, 61], [12, 84], [16, 110], [20, 74], [12, 80], [12, 80], 
        [18, 51], [18, 51], [20, 105], [20, 105], [16, 104], [20, 62], [16, 84], [16, 99], [20, 76], [16, 104], 
        [16, 87], [16, 87], [20, 76], [16, 206], [16, 157], [20, 225], [20, 225], [0, 0], [16, 74], [12, 77], 
        [12, 79], [12, 77], [16, 206], [16, 228], [18, 207]
    ];
    const alternativeConfigs = { 7: [20, 55], 8: [20, 51], 9: [24, 63] };

    // --- 核心逻辑 ---
    function getVal(id) { return parseFloat(document.getElementById(id).value) || 0; }

    function updatePaintPrice() {
        const sel = document.getElementById('I7_select');
        if (sel.value && sel.value !== "0") {
            document.getElementById('I8').value = sel.value;
            document.getElementById('A14').value = sel.options[sel.selectedIndex].text;
        }
    }

    function updateConfigSelector() {
        const a12 = parseInt(document.getElementById('A12').value);
        const group = document.getElementById('config_selector_group');
        const sel = document.getElementById('config_selector');
        sel.innerHTML = '';
        if (alternativeConfigs[a12]) {
            group.style.display = 'block';
            sel.innerHTML = `<option value="default">默认: ${machineConfig[a12-1][0]}头</option>
                             <option value="alt">备选: ${alternativeConfigs[a12][0]}头</option>`;
        } else { group.style.display = 'none'; }
    }

    function lookupMachineData() {
        const a12 = parseInt(document.getElementById('A12').value);
        let h = machineConfig[a12-1][0], p = machineConfig[a12-1][1];
        if (alternativeConfigs[a12] && document.getElementById('config_selector').value === 'alt') {
            h = alternativeConfigs[a12][0]; p = alternativeConfigs[a12][1];
        }
        document.getElementById('D14').value = h;
        document.getElementById('M14_power').value = p.toFixed(3);
    }

    function calculateMargin() {
        lookupMachineData();
        // 获取参数
        const B14=getVal('B14'), C14=getVal('C14'), D14=getVal('D14'), E14=getVal('E14'), F12=getVal('F12');
        const I8=getVal('I8'), I12=getVal('I12'), H12=getVal('H12'), S14=getVal('S14');
        const K6=document.getElementById('K6').value, M11=document.getElementById('M11').value;

        // 固定比例与查表
        const P12 = 0.038; // 损耗率
        const J12 = 1.50;  // 铜加工费
        const N12 = 1.6;   // 模具费
        const axisMap = {
            "PT10": {L9:5.18, L11:2, L12:7, K9:6.02},
            "PT15": {L9:2.37, L11:1, L12:11, K9:8.12},
            "PL8":  {L9:4.21, L11:2, L12:5, K9:7.59},
            "PL4":  {L9:5.01, L11:4, L12:2.5, K9:4.07},
            "HKV125": {L9:6.38, L11:6, L12:1.8, K9:3.72}
        };
        const destMap = {"華東":0.8, "華北":0.8, "華南":1.2, "船":2};

        // 计算公式 (保持原逻辑不变)
        const B16 = ((C14**2/4)-(B14**2/4))*3.14;
        const D16 = (1/((B14**2/4)*0.01*3.14*8.89 + B16*0.01*1.3)) * B16 * 1.3 / 100;
        const F14 = (B14/2)**2 * 3.14 * 8.89 * E14 * 60 * 24 * F12 * D14 / 1000;

        if (F14 <= 0) return alert("生产量为0，请检查输入！");

        const G14 = (0.03**2 * F14) / (B14/2)**2;
        const I14 = F14 * D16 / I12 * 100 * I8 * 1.68;
        const K14 = F14 / axisMap[K6].L12 * axisMap[K6].K9;
        const L14 = F14 * axisMap[K6].L9 / axisMap[K6].L12 / axisMap[K6].L11;
        const O14 = (I14 + (F14-F14*D16)*J12 + K14 + L14 + F14*destMap[M11] + G14*N12) * (1 + P12);
        
        const P14 = F14 * H12 - O14;
        const R14 = (S14 * getVal('M14_power')) / D14;
        const Q14 = P14 - R14 * 24 * D14 * F12;

        // UI 更新
        document.getElementById('F14').innerText = F14.toFixed(4);
        document.getElementById('O14').innerText = O14.toFixed(2);
        document.getElementById('P14').innerText = Math.round(P14).toLocaleString();
        document.getElementById('Q14').innerText = Math.round(Q14).toLocaleString();
    }

    window.onload = () => { lookupMachineData(); updateConfigSelector(); };
</script>
</body>
</html>
